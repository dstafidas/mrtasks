packages:
  yum:
    python3: []
    augeas-libs: []
    awscli-2: []

files:
  "/etc/cron.d/certbot_renew":
    mode: "000644"
    owner: root
    group: root
    content: |
      0 0,12 * * * root /usr/bin/certbot renew --quiet --post-hook "systemctl reload nginx && /usr/bin/aws s3 cp /etc/letsencrypt/live/mrtasks.com/fullchain.pem s3://mrtasks-certificates/mrtasks.com/fullchain.pem && /usr/bin/aws s3 cp /etc/letsencrypt/live/mrtasks.com/privkey.pem s3://mrtasks-certificates/mrtasks.com/privkey.pem"

commands:
  00_enable_yum_cache:
    command: |
      sed -i 's/keepcache=0/keepcache=1/' /etc/yum.conf
      mkdir -p /var/cache/yum
      echo "Enabled yum cache at $(date)" >> /var/log/eb-certs.log
  01_setup_certbot:
    command: |
      python3 -m venv /opt/certbot/
      /opt/certbot/bin/pip install --upgrade pip
      mkdir -p /opt/certbot/cache
      echo "Starting pip download at $(date)" >> /var/log/eb-certs.log
      /opt/certbot/bin/pip download certbot certbot-nginx -d /opt/certbot/cache
      echo "Finished pip download at $(date)" >> /var/log/eb-certs.log
      echo "Starting pip install at $(date)" >> /var/log/eb-certs.log
      /opt/certbot/bin/pip install certbot certbot-nginx --no-index --find-links /opt/certbot/cache
      echo "Finished pip install at $(date)" >> /var/log/eb-certs.log
      ln -sf /opt/certbot/bin/certbot /usr/bin/certbot
  02_create_dirs:
    command: |
      mkdir -p /etc/letsencrypt/live/mrtasks.com
      mkdir -p /etc/letsencrypt/archive/mrtasks.com
      echo "Created directories at $(date)" >> /var/log/eb-certs.log
  03_create_log_file:
    command: |
      touch /var/log/eb-certs.log
      chmod 644 /var/log/eb-certs.log
      chown root:root /var/log/eb-certs.log
      echo "Initialized eb-certs.log at $(date)" >> /var/log/eb-certs.log
  04_download_certificates:
    command: |
      if [ ! -f /etc/letsencrypt/archive/mrtasks.com/fullchain1.pem ] || [ ! -f /etc/letsencrypt/archive/mrtasks.com/privkey1.pem ]; then
        echo "Starting certificate download at $(date)" >> /var/log/eb-certs.log
        /usr/bin/aws s3 cp s3://mrtasks-certificates/mrtasks.com/fullchain.pem /etc/letsencrypt/archive/mrtasks.com/fullchain1.pem
        /usr/bin/aws s3 cp s3://mrtasks-certificates/mrtasks.com/privkey.pem /etc/letsencrypt/archive/mrtasks.com/privkey1.pem
        echo "Finished certificate download at $(date)" >> /var/log/eb-certs.log
        chmod 644 /etc/letsencrypt/archive/mrtasks.com/fullchain1.pem
        chmod 600 /etc/letsencrypt/archive/mrtasks.com/privkey1.pem
        chown root:root /etc/letsencrypt/archive/mrtasks.com/fullchain1.pem /etc/letsencrypt/archive/mrtasks.com/privkey1.pem
        ln -sf /etc/letsencrypt/archive/mrtasks.com/fullchain1.pem /etc/letsencrypt/live/mrtasks.com/fullchain.pem
        ln -sf /etc/letsencrypt/archive/mrtasks.com/privkey1.pem /etc/letsencrypt/live/mrtasks.com/privkey.pem
        echo "Certificates downloaded and symlinks created at $(date)" >> /var/log/eb-certs.log
      else
        echo "Certificates already exist in archive; skipping download at $(date)" >> /var/log/eb-certs.log
      fi

container_commands:
  01_restart_nginx:
    command: "systemctl restart nginx"