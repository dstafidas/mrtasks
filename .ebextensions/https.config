files:
  "/etc/cron.d/certbot_renew":
    mode: "000644"
    owner: root
    group: root
    content: |
      0 0,12 * * * root /usr/bin/certbot renew --quiet --post-hook "systemctl reload nginx && /usr/bin/aws s3 cp /etc/letsencrypt/live/mrtasks.com/fullchain.pem s3://mrtasks-certificates/mrtasks.com/fullchain.pem && /usr/bin/aws s3 cp /etc/letsencrypt/live/mrtasks.com/privkey.pem s3://mrtasks-certificates/mrtasks.com/privkey.pem"

commands:
  00_create_log_file:
    command: |
      touch /var/log/eb-certs.log
      chmod 644 /var/log/eb-certs.log
      chown root:root /var/log/eb-certs.log
      echo "Initialized eb-certs.log at $(date)" >> /var/log/eb-certs.log
  01_enable_yum_cache:
    command: |
      sed -i 's/keepcache=0/keepcache=1/' /etc/yum.conf
      mkdir -p /var/cache/yum
      echo "Enabled yum cache at $(date)" >> /var/log/eb-certs.log
  02_check_yum_cache:
    command: |
      echo "Checking yum cache at $(date)" >> /var/log/eb-certs.log
      if [ -d /var/cache/yum ]; then
        du -sh /var/cache/yum >> /var/log/eb-certs.log
      else
        echo "Yum cache directory does not exist" >> /var/log/eb-certs.log
      fi
  03_check_yum_packages:
    command: |
      echo "Checking yum packages at $(date)" >> /var/log/eb-certs.log
      if ! rpm -q python3 | grep -q "python3-3.9.21"; then
        echo "Installing python3 at $(date)" >> /var/log/eb-certs.log
        yum install -y python3-3.9.*
        echo "Finished installing python3-3.9.* at $(date)" >> /var/log/eb-certs.log
      else
        echo "python3 already installed, skipping at $(date)" >> /var/log/eb-certs.log
      fi
      if ! rpm -q augeas-libs; then
        echo "Installing augeas-libs at $(date)" >> /var/log/eb-certs.log
        yum install -y augeas-libs
        echo "Finished installing augeas-libs at $(date)" >> /var/log/eb-certs.log
      else
        echo "augeas-libs already installed, skipping at $(date)" >> /var/log/eb-certs.log
      fi
      if ! rpm -q awscli; then
        echo "Installing awscli-2 at $(date)" >> /var/log/eb-certs.log
        yum install -y awscli-2-2.23.*
        echo "Finished installing awscli-2 at $(date)" >> /var/log/eb-certs.log
      else
        echo "awscli-2 already installed, skipping at $(date)" >> /var/log/eb-certs.log
      fi
  04_check_pip_cache:
    command: |
      echo "Checking pip cache at $(date)" >> /var/log/eb-certs.log
      if [ -d /opt/certbot/cache ]; then
        du -sh /opt/certbot/cache >> /var/log/eb-certs.log
      else
        echo "Pip cache directory does not exist" >> /var/log/eb-certs.log
      fi
  05_setup_certbot:
    command: |
      if [ ! -d /opt/certbot ]; then
        echo "Creating certbot virtualenv at $(date)" >> /var/log/eb-certs.log
        python3 -m venv /opt/certbot/
        echo "Finished creating certbot virtualenv at $(date)" >> /var/log/eb-certs.log
      fi
      if ! /opt/certbot/bin/pip show certbot | grep -q "Version: 4.0.0"; then
        echo "Upgrading pip at $(date)" >> /var/log/eb-certs.log
        /opt/certbot/bin/pip install --upgrade pip
        echo "Finished upgrading pip at $(date)" >> /var/log/eb-certs.log
        mkdir -p /opt/certbot/cache
        echo "Starting pip download for certbot 4.0.0 at $(date)" >> /var/log/eb-certs.log
        /opt/certbot/bin/pip download certbot==4.0.0 certbot-nginx==4.0.0 -d /opt/certbot/cache
        echo "Finished pip download for certbot 4.0.0 at $(date)" >> /var/log/eb-certs.log
        echo "Starting pip install for certbot 4.0.0 at $(date)" >> /var/log/eb-certs.log
        /opt/certbot/bin/pip install certbot==4.0.0 certbot-nginx==4.0.0 --no-index --find-links /opt/certbot/cache
        echo "Finished pip install for certbot 4.0.0 at $(date)" >> /var/log/eb-certs.log
      else
        echo "certbot 4.0.0 already installed, skipping at $(date)" >> /var/log/eb-certs.log
      fi
      ln -sf /opt/certbot/bin/certbot /usr/bin/certbot
  06_create_dirs:
    command: |
      mkdir -p /etc/letsencrypt/live/mrtasks.com
      mkdir -p /etc/letsencrypt/archive/mrtasks.com
      echo "Created directories at $(date)" >> /var/log/eb-certs.log
  07_download_certificates:
    command: |
      if [ ! -f /etc/letsencrypt/archive/mrtasks.com/fullchain1.pem ] || [ ! -f /etc/letsencrypt/archive/mrtasks.com/privkey1.pem ]; then
        echo "Starting certificate download at $(date)" >> /var/log/eb-certs.log
        /usr/bin/aws s3 cp s3://mrtasks-certificates/mrtasks.com/fullchain.pem /etc/letsencrypt/archive/mrtasks.com/fullchain1.pem
        /usr/bin/aws s3 cp s3://mrtasks-certificates/mrtasks.com/privkey.pem /etc/letsencrypt/archive/mrtasks.com/privkey1.pem
        echo "Finished certificate download at $(date)" >> /var/log/eb-certs.log
        chmod 644 /etc/letsencrypt/archive/mrtasks.com/fullchain1.pem
        chmod 600 /etc/letsencrypt/archive/mrtasks.com/privkey1.pem
        chown root:root /etc/letsencrypt/archive/mrtasks.com/fullchain1.pem /etc/letsencrypt/archive/mrtasks.com/privkey1.pem
        ln -sf /etc/letsencrypt/archive/mrtasks.com/fullchain1.pem /etc/letsencrypt/live/mrtasks.com/fullchain.pem
        ln -sf /etc/letsencrypt/archive/mrtasks.com/privkey1.pem /etc/letsencrypt/live/mrtasks.com/privkey.pem
        echo "Certificates downloaded and symlinks created at $(date)" >> /var/log/eb-certs.log
      else
        echo "Certificates already exist in archive; skipping download at $(date)" >> /var/log/eb-certs.log
      fi

container_commands:
  01_restart_nginx:
    command: "systemctl restart nginx"
    ignoreErrors: true