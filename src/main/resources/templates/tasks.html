<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title th:text="#{tasks.title}">Tasks</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .task-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 250px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: move;
            position: relative;
        }
        .task-card h6 {
            margin-bottom: 5px;
            font-size: 1rem;
        }
        .task-card p {
            margin: 2px 0;
            font-size: 0.9rem;
        }
        .task-card .actions {
            margin-top: 5px;
        }
        .color-swatch {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .task-select {
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 th:text="#{tasks.title}">Tasks</h1>
    <a href="/profile" class="btn btn-secondary mb-3" th:text="#{tasks.profile}">Profile</a>
    <a href="/admin" sec:authorize="hasRole('ROLE_ADMIN')" class="btn btn-secondary mb-3" th:text="#{tasks.admin}">Admin</a>
    <a href="/logout" class="btn btn-danger mb-3" th:text="#{tasks.logout}">Logout</a>

    <div th:if="${param.message != null}" class="alert alert-success" th:text="${param.message}"></div>
    <div th:if="${param.error != null}" class="alert alert-danger" th:text="${param.error}"></div>

    <p th:if="${isPremium}" th:text="#{tasks.premium.status} + ' ' + ${expiresAt != null ? expiresAt : ''}">
        You are a Premium user until [expiration date].
    </p>
    <p th:unless="${isPremium}" th:text="#{tasks.free.status}">You are on a Free plan.</p>

    <div class="button-group">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
            <span>+</span> <span th:text="#{tasks.add}">Add New Task</span>
        </button>
        <div th:if="${isPremium}">
            <form id="invoiceForm" th:action="@{/invoice}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-success" th:text="#{tasks.invoice.download}" id="downloadInvoiceBtn">Download Invoice</button>
            </form>
        </div>
        <div th:unless="${isPremium}" class="alert alert-warning" th:text="#{tasks.invoice.premium}">
            Invoice generation is a Premium feature.
        </div>
    </div>

    <h2 th:text="#{tasks.list}">Task List</h2>
    <div class="row" id="task-list">
        <div class="task-card" th:each="task : ${tasks}" th:style="'background-color: ' + ${task.color}" th:data-id="${task.id}">
            <input type="checkbox" class="task-select" th:data-id="${task.id}" th:disabled="${!task.billable}">
            <h6 th:text="${task.title}">Task Title</h6>
            <p th:text="${task.description != null and task.description.length() > 0 ? (task.description.length() > 30 ? task.description.substring(0, 30) + '...' : task.description) : 'No description'}">Description</p>
            <p><strong>Client:</strong> <span class="client-name" th:text="${task.clientName != null ? task.clientName : 'N/A'}"></span></p>
            <p><strong>Deadline:</strong> <span class="deadline" th:text="${task.deadline}"></span></p>
            <p><strong>Hours:</strong> <span class="hours-worked" th:text="${task.hoursWorked}"></span></p>
            <p><strong>Rate:</strong> <span class="hourly-rate" th:text="'$' + ${task.hourlyRate}"></span></p>
            <p><strong>Total:</strong> <span class="total" th:text="'$' + ${task.total}"></span></p>
            <p><strong>Advance:</strong> <span class="advance-payment" th:text="'$' + ${task.advancePayment}"></span></p>
            <p><strong>Remaining:</strong> <span class="remaining-due" th:text="'$' + ${task.remainingDue}"></span></p>
            <div>
                <span class="color-swatch" style="background-color: #FFFFFF;" data-color="#FFFFFF" th:data-id="${task.id}" onclick="changeColor(this)"></span>
                <span class="color-swatch" style="background-color: #FFCCCC;" data-color="#FFCCCC" th:data-id="${task.id}" onclick="changeColor(this)"></span>
                <span class="color-swatch" style="background-color: #CCFFCC;" data-color="#CCFFCC" th:data-id="${task.id}" onclick="changeColor(this)"></span>
                <span class="color-swatch" style="background-color: #CCCCFF;" data-color="#CCCCFF" th:data-id="${task.id}" onclick="changeColor(this)"></span>
                <span class="color-swatch" style="background-color: #FFFFCC;" data-color="#FFFFCC" th:data-id="${task.id}" onclick="changeColor(this)"></span>
            </div>
            <div class="actions">
                <button class="btn btn-sm btn-primary edit-task-btn" th:data-id="${task.id}" th:text="#{tasks.edit.button}">Edit</button>
                <button class="btn btn-sm btn-danger delete-task-btn" th:data-id="${task.id}" th:text="#{tasks.delete.button}">Delete</button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTaskModalLabel" th:text="#{tasks.add}">Add New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addTaskForm" th:action="@{/tasks}" th:object="${newTask}" method="post">
                        <div class="mb-3">
                            <label for="title" class="form-label" th:text="#{tasks.form.title}">Title</label>
                            <input type="text" id="title" th:field="*{title}" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label" th:text="#{tasks.form.description}">Description</label>
                            <input type="text" id="description" th:field="*{description}" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="deadline" class="form-label" th:text="#{tasks.form.deadline}">Deadline</label>
                            <input type="datetime-local" id="deadline" th:field="*{deadline}" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="billable" class="form-label" th:text="#{tasks.form.billable}">Billable</label>
                            <input type="checkbox" id="billable" th:field="*{billable}" class="form-check-input">
                        </div>
                        <div class="mb-3">
                            <label for="hoursWorked" class="form-label" th:text="#{tasks.form.hours}">Hours Worked</label>
                            <input type="number" id="hoursWorked" th:field="*{hoursWorked}" step="0.1" class="form-control" value="0.0">
                        </div>
                        <div class="mb-3">
                            <label for="hourlyRate" class="form-label" th:text="#{tasks.form.rate}">Hourly Rate</label>
                            <input type="number" id="hourlyRate" th:field="*{hourlyRate}" step="0.01" class="form-control" value="0.0">
                        </div>
                        <div class="mb-3">
                            <label for="advancePayment" class="form-label" th:text="#{tasks.form.advance}">Advance Payment</label>
                            <input type="number" id="advancePayment" th:field="*{advancePayment}" step="0.01" class="form-control" value="0.0">
                        </div>
                        <div class="mb-3">
                            <label for="clientName" class="form-label" th:text="#{tasks.form.client}">Client Name</label>
                            <input type="text" id="clientName" th:field="*{clientName}" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="color" class="form-label">Color</label>
                            <select id="color" th:field="*{color}" class="form-select">
                                <option value="#FFFFFF">White</option>
                                <option value="#FFCCCC">Light Red</option>
                                <option value="#CCFFCC">Light Green</option>
                                <option value="#CCCCFF">Light Blue</option>
                                <option value="#FFFFCC">Light Yellow</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" th:text="#{tasks.form.submit}">Add Task</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTaskModalLabel" th:text="#{tasks.edit.title}">Edit Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editTaskForm" method="put">
                        <input type="hidden" id="editTaskId" name="id">
                        <div class="mb-3">
                            <label for="editTitle" class="form-label" th:text="#{tasks.form.title}">Title</label>
                            <input type="text" id="editTitle" name="title" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label" th:text="#{tasks.form.description}">Description</label>
                            <input type="text" id="editDescription" name="description" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="editDeadline" class="form-label" th:text="#{tasks.form.deadline}">Deadline</label>
                            <input type="datetime-local" id="editDeadline" name="deadline" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="editBillable" class="form-label" th:text="#{tasks.form.billable}">Billable</label>
                            <input type="checkbox" id="editBillable" name="billable" class="form-check-input">
                        </div>
                        <div class="mb-3">
                            <label for="editHoursWorked" class="form-label" th:text="#{tasks.form.hours}">Hours Worked</label>
                            <input type="number" id="editHoursWorked" name="hoursWorked" step="0.1" class="form-control" value="0.0">
                        </div>
                        <div class="mb-3">
                            <label for="editHourlyRate" class="form-label" th:text="#{tasks.form.rate}">Hourly Rate</label>
                            <input type="number" id="editHourlyRate" name="hourlyRate" step="0.01" class="form-control" value="0.0">
                        </div>
                        <div class="mb-3">
                            <label for="editAdvancePayment" class="form-label" th:text="#{tasks.form.advance}">Advance Payment</label>
                            <input type="number" id="editAdvancePayment" name="advancePayment" step="0.01" class="form-control" value="0.0">
                        </div>
                        <div class="mb-3">
                            <label for="editClientName" class="form-label" th:text="#{tasks.form.client}">Client Name</label>
                            <input type="text" id="editClientName" name="clientName" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="editColor" class="form-label">Color</label>
                            <select id="editColor" name="color" class="form-select">
                                <option value="#FFFFFF">White</option>
                                <option value="#FFCCCC">Light Red</option>
                                <option value="#CCFFCC">Light Green</option>
                                <option value="#CCCCFF">Light Blue</option>
                                <option value="#FFFFCC">Light Yellow</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" th:text="#{tasks.edit.submit}">Update Task</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    function attachEditAndDeleteListeners(element) {
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        element.querySelectorAll('.edit-task-btn').forEach(button => {
            button.addEventListener('click', function () {
                const taskId = this.getAttribute('data-id');
                fetch(`/tasks/${taskId}`, {
                    method: 'GET',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch task: ' + response.status);
                    return response.json();
                })
                .then(task => {
                    document.getElementById('editTaskId').value = task.id;
                    document.getElementById('editTitle').value = task.title;
                    document.getElementById('editDescription').value = task.description || '';
                    document.getElementById('editDeadline').value = task.deadline ? task.deadline.replace(' ', 'T').slice(0, 16) : '';
                    document.getElementById('editBillable').checked = task.billable;
                    document.getElementById('editHoursWorked').value = task.hoursWorked || 0.0;
                    document.getElementById('editHourlyRate').value = task.hourlyRate || 0.0;
                    document.getElementById('editAdvancePayment').value = task.advancePayment || 0.0;
                    document.getElementById('editClientName').value = task.clientName || '';
                    document.getElementById('editColor').value = task.color;

                    const editModal = new bootstrap.Modal(document.getElementById('editTaskModal'));
                    editModal.show();
                })
                .catch(error => console.error('Error fetching task:', error));
            });
        });

        element.querySelectorAll('.delete-task-btn').forEach(button => {
            button.addEventListener('click', function () {
                const taskId = this.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this task?')) {
                    fetch(`/tasks/${taskId}`, {
                        method: 'DELETE',
                        headers: {
                            [csrfHeader]: csrfToken
                        }
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to delete task: ' + response.status);
                        const taskCard = document.querySelector(`.task-card[data-id="${taskId}"]`);
                        if (taskCard) taskCard.remove();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete task');
                    });
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const taskList = document.getElementById('task-list');
        if (typeof Sortable !== 'undefined') {
            new Sortable(taskList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    const taskIds = Array.from(taskList.children).map(card => card.getAttribute('data-id'));
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                    fetch('/tasks/reorder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify(taskIds)
                    }).then(response => {
                        if (!response.ok) console.error('Failed to save order:', response.status);
                        else console.log('Order saved successfully');
                    }).catch(error => console.error('Error:', error));
                }
            });
        } else {
            console.error('Sortable.js failed to load');
        }

        document.querySelectorAll('.task-card').forEach(card => attachEditAndDeleteListeners(card));
    });

    function changeColor(element) {
        const taskId = element.getAttribute('data-id');
        const color = element.getAttribute('data-color');
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        fetch(`/tasks/color/${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                [csrfHeader]: csrfToken
            },
            body: `color=${encodeURIComponent(color)}`
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to update color: ' + response.status);
            return response.text();
        })
        .then(text => {
            if (text === 'Color updated') {
                const taskCard = element.closest('.task-card');
                taskCard.style.backgroundColor = color;
            } else {
                console.error('Unexpected response:', text);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    document.getElementById('addTaskForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        fetch('/tasks', {
            method: 'POST',
            headers: {
                [csrfHeader]: csrfToken
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to add task: ' + response.status);
            return response.json();
        })
        .then(task => {
            const taskList = document.getElementById('task-list');
            const newCard = document.createElement('div');
            newCard.className = 'task-card';
            newCard.setAttribute('data-id', task.id);
            newCard.style.backgroundColor = task.color;
            newCard.innerHTML = `
                <input type="checkbox" class="task-select" data-id="${task.id}" ${task.billable ? '' : 'disabled'}>
                <h6>${task.title}</h6>
                <p>${task.description && task.description.length > 0 ? (task.description.length > 30 ? task.description.substring(0, 30) + '...' : task.description) : 'No description'}</p>
                <p><strong>Client:</strong> <span class="client-name">${task.clientName || 'N/A'}</span></p>
                <p><strong>Deadline:</strong> <span class="deadline">${task.deadline || ''}</span></p>
                <p><strong>Hours:</strong> <span class="hours-worked">${task.hoursWorked}</span></p>
                <p><strong>Rate:</strong> <span class="hourly-rate">$${task.hourlyRate}</span></p>
                <p><strong>Total:</strong> <span class="total">$${task.total.toFixed(2)}</span></p>
                <p><strong>Advance:</strong> <span class="advance-payment">$${task.advancePayment.toFixed(2)}</span></p>
                <p><strong>Remaining:</strong> <span class="remaining-due">$${task.remainingDue.toFixed(2)}</span></p>
                <div>
                    <span class="color-swatch" style="background-color: #FFFFFF;" data-color="#FFFFFF" data-id="${task.id}" onclick="changeColor(this)"></span>
                    <span class="color-swatch" style="background-color: #FFCCCC;" data-color="#FFCCCC" data-id="${task.id}" onclick="changeColor(this)"></span>
                    <span class="color-swatch" style="background-color: #CCFFCC;" data-color="#CCFFCC" data-id="${task.id}" onclick="changeColor(this)"></span>
                    <span class="color-swatch" style="background-color: #CCCCFF;" data-color="#CCCCFF" data-id="${task.id}" onclick="changeColor(this)"></span>
                    <span class="color-swatch" style="background-color: #FFFFCC;" data-color="#FFFFCC" data-id="${task.id}" onclick="changeColor(this)"></span>
                </div>
                <div class="actions">
                    <button class="btn btn-sm btn-primary edit-task-btn" data-id="${task.id}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-task-btn" data-id="${task.id}">Delete</button>
                </div>
            `;
            taskList.appendChild(newCard);
            bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
            this.reset();
            attachEditAndDeleteListeners(newCard);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add task. Please try again.');
        });
    });

    document.getElementById('editTaskForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        if (!formData.get('hoursWorked')) formData.set('hoursWorked', '0.0');
        if (!formData.get('hourlyRate')) formData.set('hourlyRate', '0.0');
        if (!formData.get('advancePayment')) formData.set('advancePayment', '0.0');
        const taskId = document.getElementById('editTaskId').value;
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        fetch(`/tasks/${taskId}`, {
            method: 'PUT',
            headers: {
                [csrfHeader]: csrfToken
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to update task: ' + response.status);
            return response.json();
        })
        .then(task => {
            const taskCard = document.querySelector(`.task-card[data-id="${task.id}"]`);
            if (taskCard) {
                taskCard.querySelector('.task-select').disabled = !task.billable;
                taskCard.querySelector('h6').textContent = task.title;
                taskCard.querySelector('p:nth-child(3)').textContent = task.description && task.description.length > 0 ? (task.description.length > 30 ? task.description.substring(0, 30) + '...' : task.description) : 'No description';
                taskCard.querySelector('.client-name').textContent = task.clientName || 'N/A';
                taskCard.querySelector('.deadline').textContent = task.deadline || '';
                taskCard.querySelector('.hours-worked').textContent = task.hoursWorked;
                taskCard.querySelector('.hourly-rate').textContent = '$' + task.hourlyRate;
                taskCard.querySelector('.total').textContent = '$' + task.total.toFixed(2);
                taskCard.querySelector('.advance-payment').textContent = '$' + task.advancePayment.toFixed(2);
                taskCard.querySelector('.remaining-due').textContent = '$' + task.remainingDue.toFixed(2);
                taskCard.style.backgroundColor = task.color;
            }
            bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update task');
        });
    });

    document.getElementById('invoiceForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData();
        const selectedTaskIds = Array.from(document.querySelectorAll('.task-select:checked'))
            .map(checkbox => checkbox.getAttribute('data-id'));

        if (selectedTaskIds.length === 0) {
            alert('Please select at least one billable task to generate an invoice.');
            return;
        }

        selectedTaskIds.forEach(id => formData.append('taskIds', id));
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        fetch('/invoice', {
            method: 'POST',
            headers: {
                [csrfHeader]: csrfToken
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to generate invoice: ' + response.status);
            return response.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'invoice.pdf';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to download invoice. Please try again.');
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>