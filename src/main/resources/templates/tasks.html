<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title th:text="#{tasks.title}">Tasks</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .task-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 250px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: move;
        }
        .task-card h6 {
            margin-bottom: 5px;
            font-size: 1rem;
        }
        .task-card p {
            margin: 2px 0;
            font-size: 0.9rem;
        }
        .task-card .actions {
            margin-top: 5px;
        }
        .color-swatch {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 th:text="#{tasks.title}">Tasks</h1>
    <a href="/profile" class="btn btn-secondary mb-3" th:text="#{tasks.profile}">Profile</a>
    <a href="/admin" sec:authorize="hasRole('ROLE_ADMIN')" class="btn btn-secondary mb-3" th:text="#{tasks.admin}">Admin</a>
    <a href="/logout" class="btn btn-danger mb-3" th:text="#{tasks.logout}">Logout</a>

    <div th:if="${param.message != null}" class="alert alert-success" th:text="${param.message}"></div>
    <div th:if="${param.error != null}" class="alert alert-danger" th:text="${param.error}"></div>

    <p th:if="${isPremium}" th:text="#{tasks.premium.status} + ' ' + ${expiresAt != null ? expiresAt : ''}">
        You are a Premium user until [expiration date].
    </p>
    <p th:unless="${isPremium}" th:text="#{tasks.free.status}">You are on a Free plan.</p>

    <h2 th:text="#{tasks.list}">Task List</h2>
    <div class="row" id="task-list">
        <div class="task-card" th:each="task : ${tasks}" th:style="'background-color: ' + ${task.color}" th:data-id="${task.id}">
            <h6 th:text="${task.title}">Task Title</h6>
            <p th:text="${task.description != null and task.description.length() > 0 ? (task.description.length() > 30 ? task.description.substring(0, 30) + '...' : task.description) : 'No description'}">Description</p>
            <p><strong>Deadline:</strong> <span th:text="${task.deadline}"></span></p>
            <p><strong>Hours:</strong> <span th:text="${task.hoursWorked}"></span></p>
            <p><strong>Rate:</strong> <span th:text="'$' + ${task.hourlyRate}"></span></p>
            <p><strong>Total:</strong> <span th:text="'$' + ${task.total}"></span></p>
            <p><strong>Advance:</strong> <span th:text="'$' + ${task.advancePayment}"></span></p>
            <p><strong>Remaining:</strong> <span th:text="'$' + ${task.remainingDue}"></span></p>
            <div>
                <form th:action="@{/tasks/color/{id}(id=${task.id})}" method="post" style="display:inline;">
                    <input type="hidden" name="color" value="#FFFFFF" />
                    <span class="color-swatch" style="background-color: #FFFFFF;" onclick="this.parentNode.querySelector('input').value='#FFFFFF'; this.parentNode.submit();"></span>
                </form>
                <form th:action="@{/tasks/color/{id}(id=${task.id})}" method="post" style="display:inline;">
                    <input type="hidden" name="color" value="#FFCCCC" />
                    <span class="color-swatch" style="background-color: #FFCCCC;" onclick="this.parentNode.querySelector('input').value='#FFCCCC'; this.parentNode.submit();"></span>
                </form>
                <form th:action="@{/tasks/color/{id}(id=${task.id})}" method="post" style="display:inline;">
                    <input type="hidden" name="color" value="#CCFFCC" />
                    <span class="color-swatch" style="background-color: #CCFFCC;" onclick="this.parentNode.querySelector('input').value='#CCFFCC'; this.parentNode.submit();"></span>
                </form>
                <form th:action="@{/tasks/color/{id}(id=${task.id})}" method="post" style="display:inline;">
                    <input type="hidden" name="color" value="#CCCCFF" />
                    <span class="color-swatch" style="background-color: #CCCCFF;" onclick="this.parentNode.querySelector('input').value='#CCCCFF'; this.parentNode.submit();"></span>
                </form>
                <form th:action="@{/tasks/color/{id}(id=${task.id})}" method="post" style="display:inline;">
                    <input type="hidden" name="color" value="#FFFFCC" />
                    <span class="color-swatch" style="background-color: #FFFFCC;" onclick="this.parentNode.querySelector('input').value='#FFFFCC'; this.parentNode.submit();"></span>
                </form>
            </div>
            <div class="actions">
                <a th:href="@{/tasks/edit/{id}(id=${task.id})}" class="btn btn-sm btn-primary" th:text="#{tasks.edit.button}">Edit</a>
                <form th:action="@{/tasks/delete/{id}(id=${task.id})}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-danger" th:text="#{tasks.delete.button}" onclick="return confirm('Are you sure you want to delete this task?');">Delete</button>
                </form>
            </div>
        </div>
    </div>

    <h2 th:text="#{tasks.add}">Add New Task</h2>
    <form th:action="@{/tasks}" th:object="${newTask}" method="post">
        <div class="mb-3">
            <label for="title" class="form-label" th:text="#{tasks.form.title}">Title</label>
            <input type="text" id="title" th:field="*{title}" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label" th:text="#{tasks.form.description}">Description</label>
            <input type="text" id="description" th:field="*{description}" class="form-control">
        </div>
        <div class="mb-3">
            <label for="deadline" class="form-label" th:text="#{tasks.form.deadline}">Deadline</label>
            <input type="datetime-local" id="deadline" th:field="*{deadline}" class="form-control">
        </div>
        <div class="mb-3">
            <label for="billable" class="form-label" th:text="#{tasks.form.billable}">Billable</label>
            <input type="checkbox" id="billable" th:field="*{billable}" class="form-check-input">
        </div>
        <div class="mb-3">
            <label for="hoursWorked" class="form-label" th:text="#{tasks.form.hours}">Hours Worked</label>
            <input type="number" id="hoursWorked" th:field="*{hoursWorked}" step="0.1" class="form-control">
        </div>
        <div class="mb-3">
            <label for="hourlyRate" class="form-label" th:text="#{tasks.form.rate}">Hourly Rate</label>
            <input type="number" id="hourlyRate" th:field="*{hourlyRate}" step="0.01" class="form-control">
        </div>
        <div class="mb-3">
            <label for="advancePayment" class="form-label" th:text="#{tasks.form.advance}">Advance Payment</label>
            <input type="number" id="advancePayment" th:field="*{advancePayment}" step="0.01" class="form-control" value="0.0">
        </div>
        <div class="mb-3">
            <label for="clientName" class="form-label" th:text="#{tasks.form.client}">Client Name</label>
            <input type="text" id="clientName" th:field="*{clientName}" class="form-control">
        </div>
        <div class="mb-3">
            <label for="color" class="form-label">Color</label>
            <select id="color" th:field="*{color}" class="form-select">
                <option value="#FFFFFF">White</option>
                <option value="#FFCCCC">Light Red</option>
                <option value="#CCFFCC">Light Green</option>
                <option value="#CCCCFF">Light Blue</option>
                <option value="#FFFFCC">Light Yellow</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary" th:text="#{tasks.form.submit}">Add Task</button>
    </form>

    <h2 th:text="#{tasks.invoice}">Generate Invoice</h2>
    <div th:unless="${isPremium}" class="alert alert-warning" th:text="#{tasks.invoice.premium}">
        Invoice generation and emailing is a Premium feature.
    </div>
    <div th:if="${isPremium}">
        <a th:href="@{/invoice}" class="btn btn-success" th:text="#{tasks.invoice.download}">Download Invoice</a>
        <form th:action="@{/invoice/email}" method="post" class="mt-3">
            <div class="mb-3">
                <label for="clientNameInvoice" class="form-label" th:text="#{tasks.invoice.clientName}">Client Name</label>
                <input type="text" id="clientNameInvoice" name="clientName" class="form-control">
            </div>
            <div class="mb-3">
                <label for="clientEmail" class="form-label" th:text="#{tasks.invoice.clientEmail}">Client Email</label>
                <input type="email" id="clientEmail" name="clientEmail" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary" th:text="#{tasks.invoice.send}">Send Invoice</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const taskList = document.getElementById('task-list');
        new Sortable(taskList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                const taskIds = Array.from(taskList.children).map(card => card.getAttribute('data-id'));
                fetch('/tasks/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskIds: taskIds })
                }).then(response => {
                    if (!response.ok) console.error('Failed to save order');
                });
            }
        });
    });
</script>
</body>
</html>